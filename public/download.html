<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirePixCloud - 文件下载</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .download-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            font-family: monospace;
        }
        .verify-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
        }
        .verify-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .file-list {
            margin-top: 20px;
            display: none;
        }
        .file-item {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .download-btn {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error {
            color: #f44336;
            margin: 10px 0;
        }
        #qrScanner {
            margin-top: 20px;
            text-align: center;
        }
        .scanner-btn {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        video {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="download-container">
        <h1>FirePixCloud 文件下载</h1>
        <div id="codeInput">
            <div class="input-group">
                <label for="extractCode">提取码：</label>
                <input type="text" id="extractCode" placeholder="输入提取码" maxlength="6">
            </div>
            <div class="input-group">
                <label for="verifyCode">校验码：</label>
                <input type="text" id="verifyCode" placeholder="输入校验码" maxlength="6">
            </div>
            <button class="verify-btn" id="verifyBtn">验证</button>
            <div class="error" id="error"></div>
        </div>
        
        <div id="qrScanner">
            <button class="scanner-btn" id="scannerBtn">扫描二维码</button>
            <video id="qrVideo"></video>
        </div>

        <div class="file-list" id="fileList"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const extractCodeInput = document.getElementById('extractCode');
        const verifyCodeInput = document.getElementById('verifyCode');
        const verifyBtn = document.getElementById('verifyBtn');
        const error = document.getElementById('error');
        const fileList = document.getElementById('fileList');
        const scannerBtn = document.getElementById('scannerBtn');
        const qrVideo = document.getElementById('qrVideo');

        let html5QrcodeScanner = null;

        async function verifyAndShowFiles() {
            const extractCode = extractCodeInput.value.trim().toUpperCase();
            const verifyCode = verifyCodeInput.value.trim().toUpperCase();

            if (!extractCode || !verifyCode) {
                error.textContent = '请输入提取码和校验码';
                return;
            }

            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ extractCode, verifyCode })
                });

                const data = await response.json();

                if (data.success) {
                    displayFiles(data.files, extractCode, verifyCode);
                    error.textContent = '';
                    fileList.style.display = 'block';
                } else {
                    error.textContent = '提取码或校验码无效';
                    fileList.style.display = 'none';
                }
            } catch (err) {
                error.textContent = '验证过程中发生错误';
                console.error('Verification error:', err);
            }
        }

        function displayFiles(files, extractCode, verifyCode) {
            fileList.innerHTML = '<h3>可下载的文件：</h3>';
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileName = document.createElement('span');
                fileName.textContent = file.originalName;
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = '下载';
                downloadBtn.onclick = () => {
                    const url = `/download/${file.filename}?extractCode=${extractCode}&verifyCode=${verifyCode}`;
                    window.location.href = url;
                };

                fileItem.appendChild(fileName);
                fileItem.appendChild(downloadBtn);
                fileList.appendChild(fileItem);
            });
        }

        verifyBtn.addEventListener('click', verifyAndShowFiles);

        // 扫码功能
        scannerBtn.addEventListener('click', () => {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                qrVideo.style.display = 'none';
                scannerBtn.textContent = '扫描二维码';
                return;
            }

            scannerBtn.textContent = '关闭扫描';
            qrVideo.style.display = 'block';

            html5QrcodeScanner = new Html5Qrcode("qrVideo");
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    try {
                        const data = JSON.parse(decodedText);
                        if (data.extractCode && data.verifyCode) {
                            extractCodeInput.value = data.extractCode;
                            verifyCodeInput.value = data.verifyCode;
                            verifyAndShowFiles();
                            html5QrcodeScanner.stop();
                            html5QrcodeScanner = null;
                            qrVideo.style.display = 'none';
                            scannerBtn.textContent = '扫描二维码';
                        }
                    } catch (e) {
                        console.error('Invalid QR code data:', e);
                    }
                },
                (error) => {
                    // console.error('QR scan error:', error);
                }
            ).catch((err) => {
                console.error('Failed to start scanner:', err);
                error.textContent = '无法启动相机';
            });
        });

        // 处理回车键
        extractCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyCodeInput.focus();
            }
        });

        verifyCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyAndShowFiles();
            }
        });
    </script>
</body>
</html>
